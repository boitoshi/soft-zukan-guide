name: 🎮 ポケモン図鑑マスター デプロイ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📁 リポジトリをチェックアウト
      uses: actions/checkout@v4
    
    - name: 🔧 Node.js をセットアップ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: 📊 CSVからJSONへ変換
      run: |
        echo "🔄 ポケモンデータを変換中..."
        
        # パルデア図鑑のデータが存在する場合のみ変換
        if [ -f "SV図鑑.csv" ]; then
          node universal-csv-converter.js paldea
          echo "✅ パルデア図鑑データを変換完了"
        else
          echo "ℹ️ パルデア図鑑データが見つかりません（スキップ）"
        fi
        
        # 他のゲームのCSVファイルがあれば変換
        node universal-csv-converter.js --all
    
    - name: 📁 デプロイファイルを準備
      run: |
        echo "📦 デプロイ用ファイルを準備中..."
        
        # デプロイディレクトリを作成
        mkdir -p dist
        
        # 必要なファイルをコピー
        cp zukan-master.html dist/index.html
        cp zukan-config.json dist/
        cp *.json dist/ 2>/dev/null || echo "JSONファイルが見つかりません"
        
        # README for GitHub Pages
        cat > dist/README.md << 'EOF'
        # 🎮 ポケモン図鑑マスター
        
        **GitHub Pages デプロイ版**
        
        このディレクトリには、ポケモン図鑑マスターのデプロイ可能なファイルが含まれています。
        
        ## 🌐 アクセス方法
        
        https://[ユーザー名].github.io/[リポジトリ名]/
        
        ## 🚀 機能
        
        - 複数のポケモンゲーム図鑑に対応
        - 重複ポケモンの分析
        - 進捗の自動保存
        - レスポンシブデザイン
        
        自動生成されたファイルです 🤖
        EOF
        
        echo "✅ デプロイファイル準備完了"
        ls -la dist/
    
    - name: 🚀 GitHub Pages にデプロイ
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        commit_message: '🎮 ポケモン図鑑マスター自動デプロイ ${{ github.sha }}'
        
    - name: 📝 デプロイ結果を出力
      if: github.ref == 'refs/heads/main'
      run: |
        echo "🎉 デプロイ完了！"
        echo "🌐 アクセスURL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "📊 変換されたデータファイル:"
        ls -la dist/*.json 2>/dev/null || echo "   データファイルなし"